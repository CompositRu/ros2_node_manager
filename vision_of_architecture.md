# ROS2 Monitor — Vision of Architecture

## Обзор

ROS2 Monitor — система мониторинга и управления ROS2 нодами, работающими в Docker-контейнере автопилота. Система развёртывается на флоте устройств (трамваи, автобусы) и предоставляет веб-интерфейс для удалённого мониторинга.

---

## 1. Архитектура на целевом устройстве

### 1.1 Компоненты

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Целевое устройство (tram_30639)                                        │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  systemd: ros2-monitor.service                                    │  │
│  │                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  Python FastAPI Application                                 │  │  │
│  │  │                                                             │  │  │
│  │  │  ├── Web Server (uvicorn :8080)                            │  │  │
│  │  │  │   ├── REST API (/api/*)                                 │  │  │
│  │  │  │   ├── WebSocket (/ws/*)                                 │  │  │
│  │  │  │   └── Static files (React build)                        │  │  │
│  │  │  │                                                         │  │  │
│  │  │  ├── Services                                              │  │  │
│  │  │  │   ├── DockerService (docker ps, start, stop, logs)     │  │  │
│  │  │  │   ├── NodeService (ros2 node list, info, params)       │  │  │
│  │  │  │   ├── LogService (ros2 topic echo /rosout)             │  │  │
│  │  │  │   ├── TopicService (ros2 topic hz, echo)               │  │  │
│  │  │  │   └── AlertService (мониторинг и уведомления)          │  │  │
│  │  │  │                                                         │  │  │
│  │  │  └── Data                                                  │  │  │
│  │  │      ├── /opt/ros2-monitor/data/ (состояние, история)     │  │  │
│  │  │      └── /opt/ros2-monitor/config/ (конфигурация)         │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              │ docker exec                              │
│                              ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  Docker: tram_autoware                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  ROS2 Humble                                                │  │  │
│  │  │  ├── /sensing/* nodes                                       │  │  │
│  │  │  ├── /perception/* nodes                                    │  │  │
│  │  │  ├── /planning/* nodes                                      │  │  │
│  │  │  ├── /control/* nodes                                       │  │  │
│  │  │  └── ... (~140 nodes)                                       │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Почему вне Docker

| Аспект | ros2-monitor в Docker | ros2-monitor вне Docker |
|--------|----------------------|-------------------------|
| Мониторинг статуса автопилота | ❌ Не видит | ✅ docker ps, docker logs |
| Запуск/остановка автопилота | ❌ Нет доступа | ✅ docker start/stop |
| Переживает краш автопилота | ❌ Падает вместе | ✅ Продолжает работать |
| Показ "автопилот не запущен" | ❌ Невозможно | ✅ UI отображает статус |
| Автозапуск при включении | ⚠️ Сложнее | ✅ systemd |
| Изоляция от автопилота | ⚠️ Общие ресурсы | ✅ Полная изоляция |

### 1.3 Взаимодействие с ROS2

```
ros2-monitor (host) ──docker exec──► tram_autoware (container)
                                     │
                                     ├── ros2 node list
                                     ├── ros2 node info /node
                                     ├── ros2 param dump /node
                                     ├── ros2 topic echo /rosout
                                     ├── ros2 topic hz /topic
                                     ├── ros2 lifecycle get /node
                                     └── ros2 lifecycle set /node <transition>
```

### 1.4 Структура файлов на устройстве

```
/opt/ros2-monitor/
├── server/                     # Backend (Python)
│   ├── main.py
│   ├── config.py
│   ├── routers/
│   ├── services/
│   └── requirements.txt
├── web/
│   └── dist/                   # Frontend (собранный React)
│       ├── index.html
│       └── assets/
├── config/
│   ├── config.yaml             # Основная конфигурация
│   └── alerts.yaml             # Правила алертов
├── data/
│   ├── nodes.json              # Кэш состояния нод
│   └── history.json            # История событий
└── VERSION                     # Версия приложения

/etc/systemd/system/
└── ros2-monitor.service        # systemd unit
```

### 1.5 Конфигурация устройства

```yaml
# /opt/ros2-monitor/config/config.yaml
device:
  id: "tram_30639"
  name: "Трамвай 30639"
  type: "tram"
  
connection:
  type: docker
  container: tram_autoware
  ros_setup: /opt/ros/humble/setup.bash
  
server:
  host: 0.0.0.0
  port: 8080
  
monitoring:
  refresh_interval_sec: 5
  log_buffer_size: 1000
```

---

## 2. Варианты деплоя

### 2.1 Ручной деплой (1-5 устройств)

Для начального этапа и тестирования.

```bash
# На dev-машине: собрать
cd ros2_node_manager
cd web && npm run build && cd ..

# Скопировать на устройство
scp -r server web/dist config artem@device:/opt/ros2-monitor/

# На устройстве: установить и запустить
ssh artem@device
pip install -r /opt/ros2-monitor/server/requirements.txt
sudo systemctl restart ros2-monitor
```

**Преимущества:** Простота, не нужны дополнительные инструменты.
**Недостатки:** Не масштабируется, легко ошибиться.

### 2.2 Скрипт деплоя (5-20 устройств)

```bash
#!/bin/bash
# deploy.sh
HOSTS="10.0.1.5 10.0.1.6 10.0.1.7"

cd web && npm run build && cd ..

for HOST in $HOSTS; do
    echo "Deploying to $HOST..."
    rsync -avz --exclude 'node_modules' --exclude '.git' \
        ./ artem@$HOST:/opt/ros2-monitor/
    ssh artem@$HOST "sudo systemctl restart ros2-monitor"
done
```

**Преимущества:** Быстрее ручного, воспроизводимо.
**Недостатки:** Нет проверки состояния, нет отката.

### 2.3 Ansible (20-200 устройств) — Рекомендуемый

```
ros2_node_manager/
└── ansible/
    ├── inventory/
    │   ├── production.ini      # Боевые устройства
    │   └── staging.ini         # Тестовые устройства
    ├── roles/
    │   └── ros2-monitor/
    │       ├── tasks/main.yml
    │       ├── templates/
    │       └── files/
    ├── deploy.yml              # Деплой приложения
    ├── status.yml              # Проверка статуса
    └── rollback.yml            # Откат версии
```

**Использование:**
```bash
# Деплой на все устройства
ansible-playbook deploy.yml -i inventory/production.ini

# Деплой на конкретное устройство
ansible-playbook deploy.yml -i inventory/production.ini --limit tram_30639

# Проверка статуса
ansible-playbook status.yml -i inventory/production.ini
```

**Преимущества:** 
- Параллельный деплой на все устройства
- Идемпотентность (безопасно запускать повторно)
- Проверка состояния до/после
- Возможность отката
- Документирование инфраструктуры как код

**Недостатки:** Требует изучения Ansible, SSH доступ ко всем устройствам.

### 2.4 Pull-based деплой (200+ устройств, нестабильная сеть)

Устройство само проверяет и загружает обновления.

```
┌─────────────────────────────────────────────────────────┐
│  Update Server (S3 / HTTP / Git)                        │
│  └── releases/                                          │
│      ├── v1.0.0/ros2-monitor.tar.gz                    │
│      ├── v1.1.0/ros2-monitor.tar.gz                    │
│      └── VERSION (текущая версия)                      │
└─────────────────────────────────────────────────────────┘
                        ▲
        ┌───────────────┼───────────────┐
        │               │               │
   ┌────┴────┐    ┌────┴────┐    ┌────┴────┐
   │ Устр. 1 │    │ Устр. 2 │    │ Устр. 3 │
   │         │    │         │    │         │
   │ cron:   │    │ cron:   │    │ cron:   │
   │ check & │    │ check & │    │ check & │
   │ update  │    │ update  │    │ update  │
   └─────────┘    └─────────┘    └─────────┘
```

**Скрипт на устройстве:**
```bash
#!/bin/bash
# /opt/ros2-monitor/update.sh (запускается по cron каждые 30 минут)

CURRENT=$(cat /opt/ros2-monitor/VERSION)
LATEST=$(curl -s http://update-server/VERSION)

if [ "$CURRENT" != "$LATEST" ]; then
    curl -o /tmp/update.tar.gz "http://update-server/releases/$LATEST/ros2-monitor.tar.gz"
    systemctl stop ros2-monitor
    tar -xzf /tmp/update.tar.gz -C /opt/ros2-monitor/
    systemctl start ros2-monitor
fi
```

**Преимущества:** 
- Работает при нестабильном соединении
- Устройства обновляются когда могут
- Не требует SSH доступа к устройствам

**Недостатки:** 
- Нет контроля когда обновление произойдёт
- Сложнее откат

---

## 3. VPN для безопасного доступа

### 3.1 Зачем нужен VPN

```
Без VPN:                          С VPN:
┌─────────┐   Интернет            ┌─────────┐   Шифрованный туннель
│ Админ   │◄─────────────         │ Админ   │◄═══════════════════════
└─────────┘   Открытый :8080      └─────────┘   Только авторизованные
              Любой может                       Безопасно
```

### 3.2 Рекомендуемые решения

| Этап | Кол-во устройств | Решение | Почему |
|------|------------------|---------|--------|
| Старт | 2-50 | **Tailscale** | Бесплатно, просто, 5 минут на устройство |
| Рост | 50-100 | Tailscale (платный) | $6/user/month, всё ещё просто |
| Масштаб | 100+ | **WireGuard** | Бесплатно, полный контроль, свой сервер |

### 3.3 Tailscale (рекомендуется для старта)

```bash
# Установка на устройство (одна команда)
curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up --authkey=tskey-auth-xxxxx --hostname=tram-30639

# Результат: устройство доступно как 100.64.x.x
```

**Преимущества:**
- Mesh VPN — устройства видят друг друга напрямую
- Работает за NAT без настройки
- Веб-админка для управления
- Бесплатно до 100 устройств

### 3.4 WireGuard (для полного контроля)

Требует свой VPN-сервер с публичным IP.

```
VPN Server (203.0.113.10)
├── 10.10.0.1 - сервер
├── 10.10.0.2 - админ ноутбук
├── 10.10.0.5 - tram_30639
├── 10.10.0.6 - tram_30640
└── ...
```

**Преимущества:**
- Полный контроль
- Нет зависимости от внешних сервисов
- Нет лимитов на устройства

**Недостатки:**
- Нужен сервер с публичным IP
- Больше ручной настройки

---

## 4. Центральное приложение для мониторинга флота

### 4.1 Архитектура

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Fleet Monitor (центральный сервер)                                     │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  Web Dashboard                                                    │  │
│  │                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  🟢 tram_30639  | AP: v2.1.0 ✓ | Monitor: v1.2.0 | [Open]  │  │  │
│  │  │  🟢 tram_30640  | AP: v2.1.0 ✓ | Monitor: v1.2.0 | [Open]  │  │  │
│  │  │  🟡 tram_30641  | AP: v2.0.9 ⚠ | Monitor: v1.1.0 | [Open]  │  │  │
│  │  │  🔴 tram_30642  | AP: offline  | Monitor: v1.2.0 | [Open]  │  │  │
│  │  │  ⚫ tram_30643  | unreachable                               │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  │                                                                   │  │
│  │  Summary: 142 devices | 138 online | 3 warnings | 1 offline      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  Backend Services                                                 │  │
│  │  ├── Device Registry (список устройств, IP, версии)              │  │
│  │  ├── Health Checker (периодический опрос устройств)              │  │
│  │  ├── Version Manager (отслеживание версий)                       │  │
│  │  └── Alert Aggregator (сбор алертов со всех устройств)           │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
          │              │              │              │
          ▼              ▼              ▼              ▼
     ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
     │tram_    │   │tram_    │   │tram_    │   │tram_    │
     │30639    │   │30640    │   │30641    │   │30642    │
     │:8080    │   │:8080    │   │:8080    │   │:8080    │
     └─────────┘   └─────────┘   └─────────┘   └─────────┘
```

### 4.2 API устройства для Fleet Monitor

Каждое устройство предоставляет endpoint для центрального мониторинга:

```
GET /api/fleet/status
```

```json
{
  "device": {
    "id": "tram_30639",
    "name": "Трамвай 30639",
    "type": "tram"
  },
  "monitor": {
    "version": "1.2.0",
    "uptime_sec": 86400,
    "status": "healthy"
  },
  "autopilot": {
    "container": "tram_autoware",
    "running": true,
    "version": "2.1.0",
    "started_at": "2026-01-26T08:00:00Z",
    "nodes": {
      "total": 142,
      "active": 140,
      "inactive": 2
    }
  },
  "alerts": {
    "critical": 0,
    "warning": 2,
    "info": 5
  },
  "timestamp": "2026-01-26T15:30:00Z"
}
```

### 4.3 Вариант A: Только мониторинг (без управления деплоем)

```
Fleet Monitor
├── Dashboard
│   ├── Список устройств с статусами
│   ├── Сводная статистика
│   └── Лента алертов со всех устройств
├── Device Details
│   ├── Статус автопилота
│   ├── Версии компонентов
│   └── Кнопка "Open Device UI" → переход на :8080 устройства
└── Alerts
    ├── История алертов
    ├── Фильтрация по устройству/типу
    └── Интеграция с Telegram/Slack
```

**Функции:**
- ✅ Просмотр статуса всех устройств
- ✅ Просмотр версий автопилота и монитора
- ✅ Агрегация алертов
- ✅ Переход на UI устройства для детальной информации
- ❌ Управление деплоем (делается через Ansible отдельно)

### 4.4 Вариант B: Мониторинг + Управление деплоем

```
Fleet Monitor
├── Dashboard (как в варианте A)
├── Device Management
│   ├── Группы устройств (по депо, по маршруту)
│   ├── Массовые операции
│   └── Расписание обновлений
├── Deployment
│   ├── Версии ros2-monitor (список релизов)
│   ├── Deployment Plans (какие устройства, какая версия)
│   ├── Rollout Progress (прогресс обновления)
│   └── Rollback (откат на предыдущую версию)
└── Configuration
    ├── Шаблоны конфигурации
    ├── Переопределения для устройств
    └── Secrets management
```

**Дополнительные функции:**
- ✅ Создание deployment plan
- ✅ Поэтапное обновление (canary, blue-green)
- ✅ Мониторинг прогресса обновления
- ✅ Автоматический откат при ошибках
- ✅ Управление конфигурацией

### 4.5 Рекомендация по этапам

| Этап | Устройств | Центральное приложение |
|------|-----------|------------------------|
| MVP | 2-10 | Не нужно, только Ansible |
| v1 | 10-50 | Вариант A (только мониторинг) |
| v2 | 50-200 | Вариант B (с управлением деплоем) |

---

## 5. Безопасность

### 5.1 Уровни защиты

```
1. Сеть: VPN (Tailscale/WireGuard)
   └── Доступ только через VPN

2. Аутентификация: API Key / JWT
   └── Каждый запрос требует токен

3. Авторизация: Role-Based Access
   └── viewer: только просмотр
   └── operator: управление нодами
   └── admin: всё + деплой

4. Audit Log
   └── Все действия логируются
```

### 5.2 Пример аутентификации

```yaml
# config/config.yaml
security:
  enabled: true
  api_keys:
    - key: "fleet-monitor-key-xxx"
      role: viewer
      name: "Fleet Monitor"
    - key: "admin-key-yyy"
      role: admin
      name: "Admin"
```

---

## 6. Итоговая картина

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           VPN Network                                    │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Fleet Monitor Server                                           │    │
│  │  - Dashboard для всех устройств                                 │    │
│  │  - Агрегация алертов                                            │    │
│  │  - (опционально) Управление деплоем                             │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│         │                                                               │
│         │ HTTP/S (периодический опрос или WebSocket)                   │
│         │                                                               │
│  ┌──────┴──────┬──────────────┬──────────────┬──────────────┐          │
│  ▼             ▼              ▼              ▼              ▼          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │tram_    │ │tram_    │ │tram_    │ │bus_     │ │bus_     │          │
│  │30639    │ │30640    │ │30641    │ │10001    │ │10002    │          │
│  │         │ │         │ │         │ │         │ │         │          │
│  │ros2-    │ │ros2-    │ │ros2-    │ │ros2-    │ │ros2-    │          │
│  │monitor  │ │monitor  │ │monitor  │ │monitor  │ │monitor  │          │
│  │:8080    │ │:8080    │ │:8080    │ │:8080    │ │:8080    │          │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘          │
│       │           │           │           │           │                │
│       ▼           ▼           ▼           ▼           ▼                │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │Docker:  │ │Docker:  │ │Docker:  │ │Docker:  │ │Docker:  │          │
│  │autoware │ │autoware │ │autoware │ │autoware │ │autoware │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
└─────────────────────────────────────────────────────────────────────────┘

Админ с ноутбука:
├── Fleet Monitor → общий статус флота
├── Кликнул на устройство → открылся http://device:8080
└── Детальное управление через UI устройства
```
